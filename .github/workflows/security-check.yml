name: Security Check

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Gitleaks Secret Scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: false
      
      - name: Check for private paths
        run: |
          echo "ğŸ” Scanning for private paths..."
          
          FOUND_ISSUES=0
          
          # Patterns that should not appear
          PATTERNS=(
            "/Users/[a-zA-Z]"
            "/home/[a-zA-Z]"
            "thomashuhn"
            "jeannie-control"
            "@rockstardevelopers"
            "@accessibleai"
          )
          
          for pattern in "${PATTERNS[@]}"; do
            echo "Checking pattern: $pattern"
            if grep -rE "$pattern" \
                --include="*.html" \
                --include="*.js" \
                --include="*.mjs" \
                --include="*.json" \
                --include="*.md" \
                --include="*.sh" \
                --exclude-dir=".git" \
                --exclude="security-check.yml" \
                . 2>/dev/null; then
              echo "âŒ Found forbidden pattern: $pattern"
              FOUND_ISSUES=1
            fi
          done
          
          if [ $FOUND_ISSUES -eq 1 ]; then
            echo ""
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘  âŒ SECURITY CHECK FAILED                                 â•‘"
            echo "â•‘                                                           â•‘"
            echo "â•‘  Private paths or patterns found in the code.            â•‘"
            echo "â•‘  Please remove them before merging.                       â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            exit 1
          fi
          
          echo ""
          echo "âœ… No private paths found"
      
      - name: Check for hardcoded tokens
        run: |
          echo "ğŸ” Scanning for token patterns..."
          
          TOKEN_PATTERNS=(
            "xoxb-[0-9]"           # Slack bot tokens
            "xoxp-[0-9]"           # Slack user tokens  
            "ghp_[a-zA-Z0-9]"      # GitHub PATs
            "gho_[a-zA-Z0-9]"      # GitHub OAuth
            "sk-[a-zA-Z0-9]"       # OpenAI keys
            "AKIA[A-Z0-9]"         # AWS keys
          )
          
          FOUND_TOKENS=0
          
          for pattern in "${TOKEN_PATTERNS[@]}"; do
            if grep -rE "$pattern" \
                --include="*.html" \
                --include="*.js" \
                --include="*.mjs" \
                --include="*.json" \
                --include="*.md" \
                --include="*.sh" \
                --exclude-dir=".git" \
                . 2>/dev/null; then
              echo "âŒ Found potential token pattern: $pattern"
              FOUND_TOKENS=1
            fi
          done
          
          if [ $FOUND_TOKENS -eq 1 ]; then
            echo ""
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘  âŒ POTENTIAL SECRETS DETECTED                            â•‘"
            echo "â•‘                                                           â•‘"
            echo "â•‘  Token-like patterns found. Please verify these are      â•‘"
            echo "â•‘  not real credentials before merging.                     â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            exit 1
          fi
          
          echo "âœ… No token patterns found"
      
      - name: Summary
        if: success()
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  âœ… ALL SECURITY CHECKS PASSED                            â•‘"
          echo "â•‘                                                           â•‘"
          echo "â•‘  â€¢ No secrets detected (gitleaks)                        â•‘"
          echo "â•‘  â€¢ No private paths found                                 â•‘"
          echo "â•‘  â€¢ No token patterns found                                â•‘"
          echo "â•‘                                                           â•‘"
          echo "â•‘  Safe to merge! ğŸš€                                        â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
